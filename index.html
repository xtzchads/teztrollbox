async function loadMessages() {
  try {
    // Only show loading indicator on initial load (when no messages are displayed)
    if (
      messagesContainer.children.length === 0 ||
      messagesContainer.innerHTML.includes("loading-messages")
    ) {
      loadingMessages.style.display = "flex";
    }

    // Fetch messages from tzkt API
    const response = await axios.get(TZKT_API_URL);
    const messagesData = response.data;

    if (messagesData && messagesData.length > 0) {
      const newMessages = [];

      // Process messages
      messagesData.forEach((item) => {
        const messageData = item.value;
        newMessages.push({
          id: parseInt(item.key),
          text: messageData.message,
          sender: messageData.author,
          replyTo:
            messageData.reply_to !== null
              ? { some: parseInt(messageData.reply_to) }
              : { none: "" },
          timestamp: new Date(messageData.timestamp),
        });
      });

      // Sort messages by ID (which should correspond to chronological order)
      newMessages.sort((a, b) => a.id - b.id);

      // Check if we have new messages by comparing length or the latest message ID
      const hasNewMessages = 
        newMessages.length !== messages.length || 
        (newMessages.length > 0 && messages.length > 0 && 
         newMessages[newMessages.length - 1].id !== messages[messages.length - 1].id);

      // Update our messages array
      messages = newMessages;

      // Render if this is the first load, we just connected, or we have new messages
      if (
        messagesContainer.children.length === 0 ||
        messagesContainer.innerHTML.includes("loading-messages") ||
        hasNewMessages
      ) {
        renderMessages();
      }
    }

    loadingMessages.style.display = "none";
  } catch (error) {
    console.error("Error loading messages:", error);
    showNotification(
      "Failed to load messages. Please try again.",
      "error"
    );
    loadingMessages.style.display = "none";
  }
}
